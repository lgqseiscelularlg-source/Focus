<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealityTour AR - Final</title>

    <!-- Librer√≠as -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

    <style>
      body { margin: 0; overflow: hidden; background: black; color: white; }
      #permission-screen {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 9999;
      }
      #permission-screen button {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        margin-top: 12px;
        font-size: 16px;
      }
      #distance-label {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 8px 14px;
        border-radius: 5px;
        font-size: 14px;
        z-index: 10000;
      }
    </style>
  </head>

  <body>
    <!-- Pantalla inicial de permisos -->
    <div id="permission-screen">
      <h2>Permitir acceso</h2>
      <p>Necesitamos c√°mara, ubicaci√≥n y orientaci√≥n para mostrar la RA.</p>
      <button id="start-btn">Permitir y continuar</button>
    </div>

    <!-- Distancia -->
    <div id="distance-label" style="display:none;">Distancia: -- m</div>

    <!-- Escena AR (se activa despu√©s del permiso) -->
    <a-scene
      id="arScene"
      vr-mode-ui="false"
      embedded
      renderer="logarithmicDepthBuffer: true;"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      style="display:none;"
    >
      <a-camera gps-camera rotation-reader></a-camera>

      <a-box
        id="geoBox"
        gps-entity-place="latitude: -29.477051; longitude: -66.889616"
        color="red"
        scale="3 3 3"
        position="0 2 0"
        visible="false"
      ></a-box>
    </a-scene>

    <script>
      const objetivo = { lat: -29.477051, lon: -66.889616 };
      const radio = 5;
      const distLbl = document.getElementById("distance-label");
      const geoBox = document.getElementById("geoBox");
      const scene = document.getElementById("arScene");
      const overlay = document.getElementById("permission-screen");
      const startBtn = document.getElementById("start-btn");

      const toRad = (deg) => (deg * Math.PI) / 180;
      function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      startBtn.addEventListener("click", async () => {
        try {
          // üîπ Forzar permisos de orientaci√≥n (iOS)
          if (window.DeviceOrientationEvent?.requestPermission) {
            await DeviceOrientationEvent.requestPermission();
          }

          // üîπ Solicitar ubicaci√≥n ANTES de mostrar la escena
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              console.log("‚úÖ Permisos de ubicaci√≥n concedidos");
              overlay.style.display = "none";
              scene.style.display = "block";
              distLbl.style.display = "block";
              iniciarSeguimiento();
            },
            (err) => {
              alert("Error al obtener ubicaci√≥n: " + err.message);
            },
            { enableHighAccuracy: true, timeout: 15000 }
          );
        } catch (e) {
          alert("Error general: " + e.message);
        }
      });

      function iniciarSeguimiento() {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const dist = distanciaMetros(latitude, longitude, objetivo.lat, objetivo.lon);
            distLbl.textContent = `Distancia: ${dist.toFixed(2)} m`;

            if (dist <= radio) {
              geoBox.setAttribute("visible", "true");
            } else {
              geoBox.setAttribute("visible", "false");
            }
          },
          (err) => console.error("Error en seguimiento:", err),
          { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
        );
      }
    </script>
  </body>
</html>

