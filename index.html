<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RealityTour AR</title>

  <!-- Librer√≠as -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js@1.7.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; color:#fff; }
    #permission-screen {
      position:fixed; inset:0; display:flex; flex-direction:column;
      justify-content:center; align-items:center; background:rgba(0,0,0,.95);
      z-index:9999; text-align:center; padding:16px;
    }
    #permission-screen button{
      margin-top:12px; padding:10px 18px; border:0; border-radius:6px;
      background:#ffb300; color:#000; font-weight:600;
    }
    #distance-label{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.7); padding:6px 10px; border-radius:6px;
      font-size:14px; z-index:10000; display:none;
    }
  </style>
</head>
<body>

  <div id="permission-screen">
    <h2>Permitir acceso</h2>
    <p>Necesitamos c√°mara, ubicaci√≥n y orientaci√≥n para mostrar la RA.</p>
    <button id="start-btn">Permitir y continuar</button>
  </div>

  <div id="distance-label">Distancia: -- m</div>

  <!-- Escena AR -->
  <a-scene
    vr-mode-ui="false"
    embedded
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    // ===== Config =====
    const objetivo = { lat: -29.477051, lon: -66.889616 };
    const radio = 5; // metros

    // ===== UI =====
    const startBtn = document.getElementById('start-btn');
    const overlay  = document.getElementById('permission-screen');
    const distLbl  = document.getElementById('distance-label');

    // ===== Estado =====
    let boxCreado = false;

    // ===== Utilidades =====
    const toRad = d => d * Math.PI / 180;
    function distanciaMetros(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ===== Flujo de inicio =====
    startBtn.addEventListener('click', async () => {
      try {
        // iOS: permiso de orientaci√≥n si lo pide
        if (window.DeviceOrientationEvent?.requestPermission) {
          try { await DeviceOrientationEvent.requestPermission(); } catch {}
        }
        // Disparar permiso de ubicaci√≥n (una sola vez)
        navigator.geolocation.getCurrentPosition(
          () => {
            overlay.style.display = 'none';
            distLbl.style.display = 'block';
            iniciar();
          },
          (err) => alert('No se pudo obtener la ubicaci√≥n: ' + err.message),
          { enableHighAccuracy: true, timeout: 15000 }
        );
      } catch (e) {
        alert('Error general: ' + e.message);
      }
    });

    // ===== L√≥gica principal =====
    function iniciar() {
      // Esperamos a que el video de AR.js est√© listo
      window.addEventListener('arjs-video-loaded', () => {
        console.log('‚úÖ C√°mara lista');

        // A partir de aqu√≠, leemos posici√≥n en tiempo real
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const d = distanciaMetros(latitude, longitude, objetivo.lat, objetivo.lon);
            distLbl.textContent = `Distancia: ${d.toFixed(2)} m`;

            if (d <= radio && !boxCreado) {
              console.log('üß± Dentro del radio ‚Äî creando cubo...');
              crearCuboEnObjetivo();
              boxCreado = true;
            }
          },
          (err) => console.error('Error watchPosition:', err),
          { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
        );
      }, { once: true });
    }

    function crearCuboEnObjetivo() {
      const scene = document.querySelector('a-scene');
      const box   = document.createElement('a-box');
      box.setAttribute('id', 'geoBox');
      box.setAttribute('gps-entity-place', `latitude: ${objetivo.lat}; longitude: ${objetivo.lon}`);
      box.setAttribute('color', 'red');
      box.setAttribute('scale', '3 3 3');
      box.setAttribute('position', '0 2 0'); // 2 m de altura
      scene.appendChild(box);
    }
  </script>
</body>
</html>
